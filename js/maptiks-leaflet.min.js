!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){"use strict";function t(t){function e(){var t=new Image,e=(new Date).getTime();t.src="https://heartbeat.maptiks.com/heartbeat/a.gif?msid="+a+"&tid="+s+"&mid="+o+"&t="+e}function n(t){throw new Error(t+" must be defined")}var o=t.id,i=t.library,r=t.map,a=t.session,s=t.trackcode,p=t.debug,l=t.test,u=t.standalone,c=t.getMapState,_=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[0-9a-f]{4}-[0-9a-f]{12}$/,m=a.match(_),f=s.match(_);if(o?this._id=o.toString():n("Maptiks ID"),"leaflet"!==i&&"gmaps"!==i&&"ol3"!==i&&"esri3"!==i)throw new Error("Library must defined as leaflet, gmaps, ol3, or esri3");if(this._library=i,r){if("object"!=typeof r)throw new Error("Map must be an object");this._map=r}else n("Map");if("string"==typeof a&&""!==a){if(!m)throw new Error("Session must be a v4 UUID");this._session=a}else n("Session");if("string"==typeof s&&""!==s){if(!f)throw new Error("Trackcode not valid");this._trackcode=s}else n("Trackcode");if(p){if("boolean"!=typeof p)throw new Error("Debug must be true or false");this._debug=p}else this._debug=!1;if(l){if("boolean"!=typeof l)throw new Error("Test must be true or false");this._test=l}else this._test=!1;if(u){if("boolean"!=typeof u)throw new Error("Standalone must be true or false");this._standalone=u}else this._standalone=!1;if(c){if("function"!=typeof c)throw new Error("getMapState must be a function");this.getMapState=c}else n("getMapState");setInterval(e,6e4),e()}function e(t,e){for(var n in t)t.hasOwnProperty(n)&&"prototype"!==n&&!e[n]&&(e[n]=t[n]);return e}function n(t){var e={},n={action:"act",category:"cat",clickable:"clck",draggable:"drag",group:"grp",href:"href",id:"id",initial:"init",internal:"intr",label:"lbl",map_bbox:"bbox",map_center:"cp",map_id:"mid",map_library:"lib",map_session:"msid",map_srs:"srs",map_srs_type:"srst",map_trackcode:"tid",map_zoom:"zm",position:"pos",session:"lsid",tile_center:"tcp",tile_url:"turl",timestamp:"t",url:"url",value:"vle"};for(var o in t)t.hasOwnProperty(o)&&n.hasOwnProperty(o)?e[n[o]]=t[o]:e[o]=t[o];return e}function o(t,e){return t.replace(/\{ *([\w_]+) *\}/g,function(t,n){var o=e[n];if(void 0===o)throw new Error("No value provided for variable "+t);return"function"==typeof o&&(o=o(e)),o})}function i(){}function r(t){return t._timer=t._timer||{},t._timer.stop=function(){var e=(new Date).getTime(),n=e-this._startTime;return delete t._timer,n},t._timer._startTime=(new Date).getTime(),t}function a(){var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:7&n|8).toString(16)})}function s(t,e){return-1===t.indexOf(e)&&(t.push(e),!0)}function p(t,e){return-1!==t.indexOf(e)&&(t.splice(t.indexOf(e),1),!0)}function l(){}function u(){}function c(){}function _(){}function m(){}function f(){}function h(){}function d(t){var e=t.split("?")[0].toLowerCase();return e=e.match(/(?:(?:\/#!?\/)?(?:[^#]+))/),e=e[0].replace(/(^\/(?:#!?\/)?)?((?:\/(?:index|default)\.[a-z]{3,4})?\/?$)?(\/$)?/g,"")}function g(t,e,n){var o=null;return e=e||",",n=n||e,o=t.split(e),o.sort().toString().replace(/,/g,n)}function k(t,e){return(null===e||void 0===e||e<0)&&(e=5),Number(t.toFixed(e))}function y(){var t=this._map.getCenter(),e=this._map.getBounds(),n=e.getNorthEast(),o=e.getSouthWest(),i=k;return{bbox:[i(o.lng),i(o.lat),i(n.lng),i(n.lat)],center:[i(t.lng),i(t.lat)],zoom:this._map.getZoom()}}function b(){I._initialTimeout=100,I._initialTime=(new Date).getTime(),I.trackMapSession(),I._zoom=I.getMapState().zoom,I._map.on("moveend",I.trackPanZoom,I),I._map.on("layeradd",function(t){v(t)}),I._map.on("layerremove",function(t){v(t)})}function v(t){var e=t.layer||t.target;"layeradd"===t.type?e._tiles&&e._url?x(e):e._icon&&e._latlng?M(e):e._path&&e._latlngs?P(e):e._content&&e._latlng&&S(e):"layerremove"===t.type&&(e._tiles&&e._url&&I.trackLayerRemove(Boolean(e)?e.maptiks:null),e._content&&e._latlng&&I.trackPopupRemove(Boolean(e)?e.maptiks:null))}function x(t){t.maptiks=t.maptiks||{};var e=t.maptiks,n=Boolean(t.options)?t.options.id:null,o=Boolean(t.options)?t.options.layers:null,i=null;_.mixin(e),e._map=I._map,e._layer=t,e._url=n?t._url.replace("{id}",n):o?t._url+"?layers="+o:t._url,i=t.options.maptiks_id||t.options.sa_id||e._url,e._id=i,I.trackLayerAdd(e),t.on("loading",function(){e=r(e)}),t.on("load",function(){I.trackLayerLoad(e)}),t.on("tileloaderror",w,I)}function w(t){var e=t.target,n=t.tile,o=(e.options.tileSize||256)/2,i=k,r=e.maptiks,a=parseInt(n.style.left.replace("px",""),10)+o,s=parseInt(n.style.top.replace("px",""),10)+o,p=I._map.containerPointToLayerPoint([s,a]),l=I._map.layerPointToLatLng([p.y,p.x]);I.trackTileError(r,[i(l.lng),i(l.lat)],n.src)}function M(t){t.maptiks=t.maptiks||{};var e=k,n=t.maptiks;m.mixin(n),n._map=I._map,n._marker=t,n._position=[e(t.getLatLng().lng),e(t.getLatLng().lat)],n._group=t.options.maptiks_group||t._icon.src||t._icon.tagName.toLowerCase()+"."+g(t._icon.className," ","."),n._clickable=t.options.clickable||!0,n._draggable=t.options.draggable||!1,n._id=t.options.maptiks_id||n._position,setTimeout(function(){n._popup=t._popup||null},0),I.trackMarkerAdd(n),t.on("move",function(){L(n)}),t.on("click",function(){I.trackMarkerClick(n)}),t.on("remove",function(){I.trackMarkerRemove(n)}),t.on("dragend",function(){L(n),I.trackMarkerMove(n)})}function L(t){var e=k;t._position=[e(t._marker.getLatLng().lng),e(t._marker.getLatLng().lat)]}function P(t){t.maptiks=t.maptiks||{};var e=k,n=t.maptiks;f.mixin(n),n._map=I._map,n._path=t,n._position=function(n){var o=0,i=0,r=0,a=0;if(n=n||[{}],n[0].hasOwnProperty("lng")&&n[0].hasOwnProperty("lat")){for(var s=0;s<n.length;s++)o+=n[s].lng,i+=n[s].lat;r=o/n.length,a=i/n.length}else t.hasOwnProperty("_bounds")&&t._bounds.hasOwnProperty("_northEast")&&t._bounds.hasOwnProperty("_southWest")&&(r=(t._bounds._northEast.lng+t._bounds._southWest.lng)/2,a=(t._bounds._northEast.lat+t._bounds._southWest.lat)/2);return[e(r),e(a)]}(t._latlngs),n._group=t.options.maptiks_group||"path",n._clickable=t.options.clickable||!0,n._draggable=t.options.draggable||!1,n._id=t.options.maptiks_id||n._position,setTimeout(function(){n._popup=t._popup||null},0),t.on("click",function(){I.trackMarkerClick(n)})}function S(t){t.maptiks=t.maptiks||{};var e=k,n=t.maptiks;h.mixin(n),n._content=Boolean(t.getContent)?t.getContent():t._content,n._map=I._map,n._popup=t,n._marker=t._source||null,n._position=[e(Boolean(t.getLatLng)?t.getLatLng().lng:t._latlng.lng),e(Boolean(t.getLatLng)?t.getLatLng().lat:t._latlng.lat)],n._id=t.options.maptiks_id||n.getMarkerIcon()||n._position,n._marker&&n._marker.maptiks&&(n._marker.maptiks._popup=t),I.trackPopupAdd(n),window.addEventListener&&n._popup._contentNode?n._popup._contentNode.addEventListener("click",function t(){document.activeElement.href&&(n._popup._contentNode.removeEventListener("click",t),I.trackPopupNavigate(n,document.activeElement.href))}):window.attachEvent&&n._popup._contentNode&&n._popup._contentNode.attachEvent("onclick",function t(){document.activeElement.href&&(n._popup._contentNode.detachEvent("onclick",t),I.trackPopupNavigate(n,document.activeElement.href))})}window.maptiks=window.maptiks||{},window.maptiks.version="2017-06-07",function(){Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){var n=null;if(null===this||void 0===this)throw new TypeError('"this" is null or not defined');var o=Object(this),i=o.length>>>0;if(0===i)return-1;var r=Number(e)||0;if(Math.abs(r)===1/0&&(r=0),r>=i)return-1;for(n=Math.max(r>=0?r:i-Math.abs(r),0);n<i;){if(n in o&&o[n]===t)return n;n+=1}return-1})}(),t.mixin=function(n){e(t.prototype,n)},t.prototype={_subdomain_index:0,_getServerUrl:function(){var t=["a","b","c","d"];this._subdomain_index>=t.length&&(this._subdomain_index=0);var e=o("https://{s}.maptiks.com/store/a.gif",{s:t[this._subdomain_index]});return this._subdomain_index+=1,e},getId:function(){return this._id},getLibrary:function(){return this._library},getMapState:function(){throw new Error("getMapState has not been overriden with map library")},getSession:function(){return this._session},getTrackcode:function(){return this._trackcode},track:function(t){var e=[],o=new Image,i=this.getMapState();if("object"!=typeof t||t==={})return null;t.map_id=this.getId(),t.map_library=this.getLibrary(),t.map_session=this.getSession(),t.map_trackcode=this.getTrackcode(),t.map_bbox=i.bbox,t.map_center=i.center,t.map_zoom=i.zoom,t.map_srs=i.srs,t.map_srs_type=i.srs_type,t.timestamp=(new Date).getTime();var r=n(t);if(console&&this._debug)console.log(r);else if(console&&this._test)for(var a=Object.keys(r).sort(),s=0;s<a.length;s++)console.log(s,a[s],r[a[s]]);else{for(var p in r)r.hasOwnProperty(p)&&Boolean(void 0!==r[p])&&Boolean(null!==r[p])&&e.push(encodeURIComponent(p)+"="+encodeURIComponent(r[p]));o.src=this._getServerUrl()+"?"+e.join("&")}return r}},i.mixin=function(t){e(i.prototype,t)},i.prototype={_mapSessionTracked:null,getMap:function(){return this._map},_trackMap:function(t){this._standalone||this.track({category:t.category,action:t.action,label:t.label,internal:!0})},trackMapSession:function(){this._mapSessionTracked||(this._mapSessionTracked=!0,this._trackMap({category:"map",action:"mapload",label:"mapsession"}))},trackPanZoom:function(){this.getMapState().zoom===this._zoom?this._trackMap({category:"map",action:"mapactivity",label:"pan"}):this._zoom&&this._trackMap({category:"map",action:"mapactivity",label:"zoom"}),this._zoom=this.getMapState().zoom}},l.mixin=function(t){e(l.prototype,t)},l.prototype={_layers:null,_trackLayer:function(t,e){this._standalone||this.track({category:e.category,action:e.action,label:e.label,value:e.value,id:t.getId(),session:t.getSession(),url:t.getUrl(),tile_center:e.tile_center,tile_url:e.tile_url,internal:!0})},getLayers:function(){return this._layers},trackLayerAdd:function(t){t._session=a(),t=r(t),s(this._layers,t._layer),t._source&&t._source.maptiks&&s(t._source.maptiks._layers,t._layer),this._trackLayer(t,{category:"layersession",action:"statechange",label:"active"})},trackLayerRemove:function(t){this._trackLayer(t,{category:"layersession",action:"statechange",label:"inactive"}),t._session=null,p(this._layers,t._layer),t._source&&t._source.maptiks&&p(t._source.maptiks._layers,t._layer)},trackLayerLoad:function(t){t._timer&&t.getSession()&&this._trackLayer(t,{category:"tlayer",action:"layerload",value:t._timer.stop()})},trackTileError:function(t,e,n){this._trackLayer(t,{category:"tlayer",action:"tileerror",tile_center:e,tile_url:n})}},u.mixin=function(t){e(u.prototype,t)},u.prototype={_markers:null,_trackMarker:function(t,e){this._standalone||this.track({category:"marker",action:e.action,value:e.value,id:t.getId(),group:t.getGroup(),position:t.getPosition(),clickable:t.isClickable(),draggable:t.isDraggable(),map_srs:t.srs,map_srs_type:t.srs_type,internal:!0})},getMarkers:function(){return this._markers},trackMarkerAdd:function(t){t=r(t),s(this._markers,t._marker)},trackMarkerClick:function(t){this._trackMarker(t,{action:"click"})},trackMarkerMove:function(t){this._trackMarker(t,{action:"move"})},trackMarkerRemove:function(t){p(this._markers,t._marker)}},c.mixin=function(t){e(c.prototype,t)},c.prototype={_popups:null,_trackPopup:function(t,e){this._standalone||this.track({category:"popup",action:e.action,value:e.value,href:e.href,id:t.getId(),position:t.getPosition(),internal:!0})},getPopups:function(){return this._popups},trackPopupAdd:function(t){t=r(t),s(this._popups,t._popup),this._trackPopup(t,{action:"add"})},trackPopupRemove:function(t){p(this._popups,t._popup),t._timer&&this._trackPopup(t,{action:"remove",value:t._timer.stop()})},trackPopupNavigate:function(t,e){t._timer&&(this._trackPopup(t,{action:"navigate",value:t._timer.stop(),href:e}),t=r(t))}},_.mixin=function(t){e(_.prototype,t)},_.prototype={_layer:null,_map:null,_id:null,_session:null,_url:null,getId:function(){return this._id},getLayer:function(){return this._layer},getMap:function(){return this._map},getSession:function(){return this._session},getUrl:function(){return this._url}},m.mixin=function(t){e(m.prototype,t)},m.prototype={_clickable:null,_draggable:null,_id:null,_group:null,_map:null,_marker:null,_popup:null,_position:null,getGroup:function(){return this._group},getId:function(){return this._id},getMap:function(){return this._map},getMarker:function(){return this._marker},getPopup:function(){return this._popup},getPosition:function(){return this._position},hasPopup:function(){return Boolean(this._popup)},isClickable:function(){return this._clickable},isDraggable:function(){return this._draggable},isPopupActive:function(){return Boolean(-1!==this._map.maptiks._popups.indexOf(this._popup))}},f.mixin=function(t){e(f.prototype,t)},f.prototype={_group:null,_id:null,_map:null,_path:null,_popup:null,_position:null,getGroup:function(){return this._group},getId:function(){return this._id},getMap:function(){return this._map},getPath:function(){return this._path},getPopup:function(){return this._popup},getPosition:function(){return this._position},hasPopup:function(){return Boolean(this._popup)},isClickable:function(){return this._clickable},isDraggable:function(){return this._draggable},isPopupActive:function(){return Boolean(-1!==this._map.maptiks._popups.indexOf(this._popup))}},h.mixin=function(t){e(h.prototype,t)},h.prototype={_content:null,_map:null,_id:null,_marker:null,_popup:null,_position:null,getContent:function(){return this._content},getId:function(){return this._id},getMap:function(){return this._map},getMarker:function(){return this._marker},getMarkerIcon:function(){return Boolean(this._marker&&this._marker.maptiks)?this._marker.maptiks._icon:null},getPopup:function(){return this._popup},getPosition:function(){return this._position},hasMarker:function(){return Boolean(this._marker)}};var E=window.L,T=window.maptiks,I=null;E.Map.addInitHook(function(){var e=T.trackcode||this.options.maptiks_trackcode||this.options.track_id||null;e&&!this.options.maptiks_notrack&&(this.maptiks=new t({id:this.options.maptiks_id||this.options.sa_id||d(window.location.pathname+window.location.hash)+"/:"+this._container.id,library:"leaflet",map:this,session:a(),trackcode:e,debug:T.debug||this.options.maptiks_debug,test:T.test||this.options.maptiks_test,standalone:T.standalone||this.options.maptiks_standalone,getMapState:y}),I=this.maptiks,i.mixin(I),l.mixin(I),I._layers=[],u.mixin(I),I._markers=[],c.mixin(I),I._popups=[]),I&&(void 0===this.getZoom()?this.once("load",b,I):b())});var O=E.TileLayer.prototype._tileOnError;E.TileLayer.prototype._tileOnError=function(){var t=this._layer||this,e=arguments[1]||this;t.fire("tileloaderror",{tile:e}),O.apply(this,arguments)},function(t,e){function n(){}n.prototype=e.prototype,t.superClass_=e.prototype,t.prototype=new n,t.prototype.constructor=t}(E.TileLayer.prototype._tileOnError,O)});